<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.jk51.modules.appInterface.mapper.BMemberInfoMapper">

    <select id="findCountRegistNum" resultType="java.lang.Integer">
        SELECT count(*)
        from b_member_info
        WHERE
        invite_code like CONCAT("%",#{invitationCode},"%")
        <if test="time!=null">
            AND
            create_time like CONCAT("%",#{time},"%")
        </if>
        AND
        status = 0
        AND
        site_id = #{siteId}
    </select>
    <select id="getRegisteDate" resultType="java.util.Date">
        SELECT create_time
        from b_member_info
        WHERE
        invite_code like CONCAT("%",#{invitationCode},"%")
        AND create_time like CONCAT("%",#{month},"%")
        AND status = 0
         AND
          site_id = #{siteId}
    </select>

    <select id="findMemberInfoList" resultType="com.jk51.model.order.SBMemberInfo">
        SELECT *
        from b_member_info
        WHERE
          invite_code like CONCAT("%",#{invitationCode},"%")
          AND
          create_time like CONCAT("%",#{date},"%")
          AND
          status = 0
            AND
          site_id = #{siteId}
        ORDER by create_time DESC

    </select>

    <!--会员添加start-->

    <insert id="insert" useGeneratedKeys="true" keyProperty="id" parameterType="com.jk51.model.order.SBMemberInfo">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into b_member_info (id, site_id, member_id,
        birthday, concerned, concerned_time,
        integrate, integrate_used, checkin_num,
        checkin_sum, checkin_lasttime, weixin_code,
        qq, membership_number, barcode,
        country, province, city,
        area, address, age,
        yibao_card, status, store_id,
        avatar, invite_code, create_time,
        update_time, tag)
        values (#{id,jdbcType=INTEGER}, #{site_id,jdbcType=INTEGER}, #{member_id,jdbcType=INTEGER},
        #{birthday,jdbcType=DATE}, #{concerned,jdbcType=TINYINT}, #{concerned_time,jdbcType=TIMESTAMP},
        #{integrate,jdbcType=INTEGER}, #{integrate_used,jdbcType=INTEGER}, #{checkin_num,jdbcType=INTEGER},
        #{checkin_sum,jdbcType=INTEGER}, #{checkin_lasttime,jdbcType=TIMESTAMP}, #{weixin_code,jdbcType=VARCHAR},
        #{qq,jdbcType=VARCHAR}, #{membership_number,jdbcType=VARCHAR}, #{barcode,jdbcType=VARCHAR},
        #{country,jdbcType=INTEGER}, #{province,jdbcType=INTEGER}, #{city,jdbcType=INTEGER},
        #{area,jdbcType=INTEGER}, #{address,jdbcType=VARCHAR}, #{age,jdbcType=SMALLINT},
        #{yibao_card,jdbcType=VARCHAR}, #{status,jdbcType=TINYINT}, #{store_id,jdbcType=INTEGER},
        #{avatar,jdbcType=VARCHAR}, #{invite_code,jdbcType=VARCHAR}, #{create_time,jdbcType=TIMESTAMP},
        #{update_time,jdbcType=TIMESTAMP}, #{tag,jdbcType=LONGVARCHAR})
    </insert>


    <insert id="insertSelective" useGeneratedKeys="true" keyProperty="id"
            parameterType="com.jk51.model.order.SBMemberInfo">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into b_member_info
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="site_id != null">
                site_id,
            </if>
            <if test="member_id != null">
                member_id,
            </if>
            <if test="birthday != null">
                birthday,
            </if>
            <if test="concerned != null">
                concerned,
            </if>
            <if test="concerned_time != null">
                concerned_time,
            </if>
            <if test="integrate != null">
                integrate,
            </if>
            <if test="integrate_used != null">
                integrate_used,
            </if>
            <if test="checkin_num != null">
                checkin_num,
            </if>
            <if test="checkin_sum != null">
                checkin_sum,
            </if>
            <if test="checkin_lasttime != null">
                checkin_lasttime,
            </if>
            <if test="weixin_code != null">
                weixin_code,
            </if>
            <if test="qq != null">
                qq,
            </if>
            <if test="membership_number != null">
                membership_number,
            </if>
            <if test="barcode != null">
                barcode,
            </if>
            <if test="country != null">
                country,
            </if>
            <if test="province != null">
                province,
            </if>
            <if test="city != null">
                city,
            </if>
            <if test="area != null">
                area,
            </if>
            <if test="address != null">
                address,
            </if>
            <if test="tag != null">
                tag,
            </if>
            <if test="age != null">
                age,
            </if>
            <if test="yibao_card != null">
                yibao_card,
            </if>
            <if test="status != null">
                status,
            </if>
            <if test="store_id != null">
                store_id,
            </if>
            <if test="avatar != null">
                avatar,
            </if>
            <if test="invite_code != null">
                invite_code,
            </if>
            <if test="create_time != null">
                create_time,
            </if>
            <if test="update_time != null">
                update_time
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="site_id != null">
                #{site_id,jdbcType=INTEGER},
            </if>
            <if test="member_id != null">
                #{member_id,jdbcType=INTEGER},
            </if>
            <if test="birthday != null">
                #{birthday,jdbcType=DATE},
            </if>
            <if test="concerned != null">
                #{concerned,jdbcType=TINYINT},
            </if>
            <if test="concerned_time != null">
                #{concerned_time,jdbcType=TIMESTAMP},
            </if>
            <if test="integrate != null">
                #{integrate,jdbcType=INTEGER},
            </if>
            <if test="integrate_used != null">
                #{integrate_used,jdbcType=INTEGER},
            </if>
            <if test="checkin_num != null">
                #{checkin_num,jdbcType=INTEGER},
            </if>
            <if test="checkin_sum != null">
                #{checkin_sum,jdbcType=INTEGER},
            </if>
            <if test="checkin_lasttime != null">
                #{checkin_lasttime,jdbcType=TIMESTAMP},
            </if>
            <if test="weixin_code != null">
                #{weixin_code,jdbcType=VARCHAR},
            </if>
            <if test="qq != null">
                #{qq,jdbcType=VARCHAR},
            </if>
            <if test="membership_number != null">
                #{membership_number,jdbcType=VARCHAR},
            </if>
            <if test="barcode != null">
                #{barcode,jdbcType=VARCHAR},
            </if>
            <if test="country != null">
                #{country,jdbcType=INTEGER},
            </if>
            <if test="province != null">
                #{province,jdbcType=INTEGER},
            </if>
            <if test="city != null">
                #{city,jdbcType=INTEGER},
            </if>
            <if test="area != null">
                #{area,jdbcType=INTEGER},
            </if>
            <if test="address != null">
                #{address,jdbcType=VARCHAR},
            </if>
            <if test="tag != null">
                #{tag,jdbcType=LONGVARCHAR},
            </if>
            <if test="age != null">
                #{age,jdbcType=SMALLINT},
            </if>
            <if test="yibao_card != null">
                #{yibao_card,jdbcType=VARCHAR},
            </if>
            <if test="status != null">
                #{status,jdbcType=TINYINT},
            </if>
            <if test="store_id != null">
                #{store_id,jdbcType=INTEGER},
            </if>
            <if test="avatar != null">
                #{avatar,jdbcType=VARCHAR},
            </if>
            <if test="invite_code != null">
                #{invite_code,jdbcType=VARCHAR},
            </if>
            <if test="create_time != null">
                #{create_time,jdbcType=TIMESTAMP},
            </if>
            <if test="update_time != null">
                #{update_time,jdbcType=TIMESTAMP}
            </if>
        </trim>
    </insert>

    <!--会员添加end-->

    <!--会员修改start-->

    <select id="getMemberInfo" resultType="com.jk51.model.order.SBMemberInfo">
        SELECT *
        FROM b_member_info
        <where>
            member_id = #{member_id} AND site_id = #{site_id}
        </where>
        limit 1
    </select>

    <update id="updateMemberInfoByMemberId" parameterType="com.jk51.model.order.SBMemberInfo">

        UPDATE b_member_info
        <set>
            <if test="birthday != null">
                birthday = #{birthday,jdbcType=DATE},
            </if>
            <if test="concerned != null">
                concerned = #{concerned,jdbcType=TINYINT},
            </if>
            <if test="concerned_time != null">
                concerned_time = #{concerned_time,jdbcType=TIMESTAMP},
            </if>
            <if test="integrate != null">
                integrate = #{integrate,jdbcType=INTEGER},
            </if>
            <if test="integrate_used != null">
                integrate_used = #{integrate_used,jdbcType=INTEGER},
            </if>
            <if test="checkin_num != null">
                checkin_num = #{checkin_num,jdbcType=INTEGER},
            </if>
            <if test="checkin_sum != null">
                checkin_sum = #{checkin_sum,jdbcType=INTEGER},
            </if>
            <if test="checkin_lasttime != null">
                checkin_lasttime = #{checkin_lasttime,jdbcType=TIMESTAMP},
            </if>
            <if test="weixin_code != null">
                weixin_code = #{weixin_code,jdbcType=VARCHAR},
            </if>
            <if test="qq != null">
                qq = #{qq,jdbcType=VARCHAR},
            </if>
            <if test="membership_number != null">
                membership_number = #{membership_number,jdbcType=VARCHAR},
            </if>
            <if test="barcode != null">
                barcode = #{barcode,jdbcType=VARCHAR},
            </if>
            <if test="country != null">
                country = #{country,jdbcType=INTEGER},
            </if>
            <if test="province != null">
                province = #{province,jdbcType=INTEGER},
            </if>
            <if test="city != null">
                city = #{city,jdbcType=INTEGER},
            </if>
            <if test="area != null">
                area = #{area,jdbcType=INTEGER},
            </if>
            <if test="address != null">
                address = #{address,jdbcType=VARCHAR},
            </if>
            <if test="age != null">
                age = #{age,jdbcType=SMALLINT},
            </if>
            <if test="yibao_card != null">
                yibao_card = #{yibao_card,jdbcType=VARCHAR},
            </if>
            <if test="status != null">
                status = #{status,jdbcType=TINYINT},
            </if>
            <if test="store_id != null">
                store_id = #{store_id,jdbcType=INTEGER},
            </if>
            <if test="avatar != null">
                avatar = #{avatar,jdbcType=VARCHAR},
            </if>
            <if test="invite_code != null">
                invite_code = #{invite_code,jdbcType=VARCHAR},
            </if>
            <if test="tag != null">
                tag = #{tag,jdbcType=LONGVARCHAR},
            </if>
        </set>
        <where>
            site_id = #{site_id} AND member_id = #{member_id}
        </where>

    </update>
    <update id="updateMemberInfo" parameterType="java.util.Map">
        UPDATE b_member_info
        <set>
            <if test="birthday!=null">
                birthday=#{birthday},
            </if>
            <if test="province!=null">
                province=#{province},
            </if>
            <if test="city!=null">
                city=#{city},
            </if>
            <if test="area!=null">
                area=#{area},
            </if>
            <if test="address!=null">
                address=#{address},
            </if>
            <if test="card_no!=null">
                membership_number=#{card_no}
            </if>
        </set>
        WHERE site_id=#{site_id} AND member_id=#{member_id}
    </update>
    <select id="appselectmembernum" resultType="java.util.Map">
        select date(bmi.create_time) as query_time,count(*) as value from b_member_info bmi left JOIN b_store_adminext
        bsa ON bmi.site_id=bsa.site_id
        and bmi.invite_code=bsa.clerk_invitation_code
        where bmi.site_id=#{siteId}
        and bsa.store_id=#{storeId}
        <if test="storeUserId!=null">
            AND bsa.storeadmin_id=#{storeUserId}
        </if>
        and bmi.invite_code!=''
        and bmi.create_time between #{start}
        and #{end}
        group by query_time
        order by query_time asc
    </select>
    <select id="appselectmembernum2" resultType="java.util.Map">
        select date(create_time) as query_time,count(*) as value from b_member
        where site_id=#{siteId}
        and register_stores=#{storeId}
        <if test="storeUserId!=null">
            AND register_clerks=#{storeUserId}
        </if>
        and create_time between #{start}
        and #{end}
        group by query_time
        order by query_time asc;
    </select>
    <select id="erpGetMemberInfo" resultType="java.util.Map">
        SELECT
        bs.id AS id,
        bs.stores_number AS uid,
        bs. NAME AS storeName,
        bsat.storeadmin_id AS clerkId,
        bsat. NAME AS clerkname,
        bm.create_time as ctime,
        bm.first_erp as firsterp
        FROM
        b_member bm
        LEFT JOIN b_member_info bmi ON bmi.site_id = bm.site_id
        AND bmi.member_id = bm.buyer_id
        LEFT JOIN b_store_adminext bsat ON bm.site_id = bsat.site_id
        AND bmi.invite_code = bsat.clerk_invitation_code
        LEFT JOIN b_stores bs ON bsat.site_id = bs.site_id
        AND bsat.store_id = bs.id
        WHERE bm.site_id=#{siteId}
        <if test="invite_code!=null">
            and bmi.invite_code=#{invite_code}
        </if>
        and bm.mobile=#{mobile} limit 1
    </select>
    <update id="updateCardNo">
        update b_member_info set membership_number =#{cardNo} where site_id=#{siteId} and member_id=#{buyerId}
    </update>
    <select id="selectRegistMemInfo" resultType="java.util.Map">
SELECT
	bm.create_time ctime,
	bm.first_erp firsterp,
	bm.name memberName,
	bs.id id,
	bs.site_id siteId,
	bs.stores_number uid,
	bs.`name` storeName,
	bsat.storeadmin_id clerkId,
	bsat.`name` clerkName
FROM
	b_member bm
LEFT JOIN b_stores bs ON bs.site_id = bm.site_id
AND bs.id = bm.register_stores
LEFT JOIN b_store_admin bsa ON bm.site_id = bsa.site_id
AND bm.register_clerks = bsa.id
LEFT JOIN b_store_adminext bsat ON bsa.site_id = bsat.site_id
AND bsa.id = bsat.storeadmin_id
WHERE
	bm.mobile = #{mobile}
AND bm.site_id = #{siteId};
    </select>
</mapper>

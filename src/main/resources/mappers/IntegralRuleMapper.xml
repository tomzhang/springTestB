<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jk51.modules.integral.mapper.IntegralRuleMapper">

    <resultMap id="RuleEntityList" type="com.jk51.modules.integral.domain.IntegralRuleEntity" autoMapping="true">
        <!-- WARNING - @mbggenerated This element is automatically generated by
            MyBatis Generator, do not modify. This element was generated on Tue Aug 14
            11:14:40 CST 2012. -->
        <result column="id" property="id"/>
        <result column="site_id" property="siteId"/>
        <result column="desc" property="desc"/>
        <result column="type" property="type"/>
        <result column="rule" property="rule"/>
        <result column="limit" property="limit"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <select id="queryIntegralRules" resultMap="RuleEntityList" useCache="false" timeout="1800" flushCache="false">
        SELECT * from b_integral_rule
        /*SELECT id,site_id,name, desc,type,rule,limit,status,DATE_FORMAT(create_time,'%Y-%m-%d
        %H:%i:%s'),DATE_FORMAT(update_time,'%Y-%m-%d %H:%i:%s') from b_integral_rule*/
        <where>
            site_id = #{siteId}
        </where>
        order by type
    </select>

    <insert id="insertRegisterRule" parameterType="com.jk51.modules.integral.domain.IntegralRuleEntity">
        INSERT into `b_integral_rule` (id,site_id,name,desc,type,rule,status) VALUES (null,#{siteId},#{name},#{desc},#{type},#{rule},#{status});
    </insert>

    <select id="queryRegisterRule" resultType="com.jk51.modules.integral.domain.IntegralRuleEntity" useCache="false"
            timeout="1800" flushCache="false">
        SELECT id,site_id,name, desc,type,rule,limit,status,DATE_FORMAT(create_time,'%Y-%m-%d
        %H:%i:%s'),DATE_FORMAT(update_time,'%Y-%m-%d %H:%i:%s') from b_integral_rule
        <where>
            site_id = #{siteId}
            AND
            type = 10
        </where>
    </select>

    <update id="updateRegisterRule" parameterType="com.jk51.modules.integral.domain.IntegralRuleEntity">
        UPDATE `b_integral_rule`
        <set>
            desc = #{desc},
            rule = #{rule}
            status = #{status}
            update_time = #{updateTime}
        </set>
        WHERE
        site_id = #{siteId}
        AND
        id = #{id}
    </update>


    <insert id="insertRule" parameterType="java.util.Map" useGeneratedKeys="true" keyColumn="id" keyProperty="id">
        insert into b_integral_rule (site_id,name,type,rule,`limit`,status,`desc`)
        values (#{siteId},#{name},#{type},#{rule},#{limit},#{status},#{desc})
    </insert>

    <insert id="insertRuleLog" parameterType="java.util.Map">
        insert into b_integral_rule_log (rule_id,rule_name,before_status,after_status,opateror_id,operator_name)
        values (#{ruleId},#{ruleName},#{beforeStatus},#{afterStatus},#{opaterorId},#{operatorName})
    </insert>

    <update id="updateRule" parameterType="java.util.Map">
        update b_integral_rule
        <set>
            <if test="rule!=null and rule !=''">rule=#{rule},</if>
            <if test="type!=null and type !=''">type=#{type},</if>
            <if test="desc!=null and desc !=''">`desc`=#{desc},</if>
            <if test="limit !=''">`limit`=#{limit},</if>
            <if test="status!=null and status !=''">status=#{status},</if>
        </set>
        where site_id =#{site_id} and id = #{id}
    </update>

    <select id="queryIntegral" resultType="java.util.Map" parameterType="java.util.Map">
        SELECT * from b_integral_rule where type=#{type} and site_id=#{site_id} LIMIT 1
    </select>

    <select id="getIntegralRuleLog" resultType="java.util.Map" parameterType="java.util.Map">
        SELECT a.id ruleId,a.name,a.desc,a.limit,a.status,b.* from  b_integral_rule a RIGHT JOIN b_integral_rule_log b on a.id = b.rule_id where a.site_id = #{siteId} order by b.update_time desc,a.name desc,b.id desc
    </select>

    <select id="checkinNumber" parameterType="java.util.Map" resultType="java.util.Map" useCache="false">
        select checkin_num,checkin_sum,checkin_lasttime,DATE_FORMAT(DATE_SUB(NOW(),INTERVAL 1 DAY),'%Y-%m-%d') AS yesterday from b_member_info where site_id=#{siteId} and member_id=#{buyerId}
    </select>

    <select id="isGiveIntegral" parameterType="java.util.Map" resultType="java.util.Map" useCache="false">
        select * from b_integrallog where site_id = #{siteId}
            and member_id = #{buyerId}
            and type = #{type}
            and to_days(now())-to_days(create_time) = 0
        order by create_time desc
    </select>

    <select id="queryIntegralRule" parameterType="java.util.Map" resultType="java.util.Map" useCache="false">
        select * from b_integral_rule where site_id = #{siteId} and type=#{type} and status=1
    </select>
    <select id="getIntegralRule" parameterType="java.util.Map" resultType="com.jk51.model.integral.IntegralRule">
        select * from b_integral_rule where site_id = #{siteId} and type=#{type} and status=1
    </select>

    <select id="memberIntegral" parameterType="java.util.Map" resultType="java.util.Map" useCache="false">
        select integrate,total_get_integrate,total_consume_integrate,mobile from b_member where site_id = #{siteId} and buyer_id = #{buyerId}
    </select>

    <select id="memberInfo" parameterType="java.util.Map" resultType="java.util.Map">
        SELECT a.site_id siteId,a.buyer_id buyerId,a.integrate,a.total_get_integrate,a.total_consume_integrate,mobile,b.*  from b_member a INNER join b_member_info b on a.buyer_id=b.member_id where a.site_id=#{siteId} and a.buyer_id=#{buyerId} and b.site_id=#{siteId}
    </select>

    <update id="updateMemberIntegral" parameterType="java.util.Map">
        update b_member set integrate= #{integrate},total_get_integrate = #{totalGetIntegrate}
        where site_id = #{siteId} and buyer_id = #{buyerId}
    </update>

    <update id="updateMemberInfo" parameterType="java.util.Map">
        update b_member_info set integrate= #{integrate},
        checkin_num=#{checkinNum},checkin_sum=#{checkinSum},
        checkin_lasttime=NOW()
        where site_id = #{siteId} and member_id = #{buyerId}
    </update>

    <insert id="insertIntegralLog" parameterType="java.util.Map">
        insert into b_integrallog
        (site_id,member_id,buyer_nick,integral_desc,integral_add,integral_diff,integral_overplus,mark,`type`)
        VALUES
        (#{siteId},#{buyerId},#{buyerNick},#{integralDesc},#{integralAdd},#{integralDiff},#{integralOverplus},#{mark},#{type})
    </insert>

    <insert id="insertlogList">
        insert into b_integrallog
        (site_id,member_id,buyer_nick,integral_desc,integral_diff,integral_overplus,mark,`type`)
        VALUES
            (#{siteId},#{buyerId},#{mobile},#{desc},#{on_costScore},#{on_integral},#{mark},#{type})
    </insert>
    <update id="updateMemberIntegralbyOffChange" parameterType="java.util.Map">
        update b_member SET integrate=#{integrate},total_consume_integrate=#{total_consume_integrate} where site_id = #{siteId} and buyer_id = #{buyerId}
    </update>
</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jk51.modules.registration.mapper.ServceUseDetailMapper">
    <resultMap id="BaseResultMap" type="com.jk51.model.registration.models.ServceUseDetail">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="bsud_id" jdbcType="INTEGER" property="id"/>
        <id column="bsud_site_id" jdbcType="INTEGER" property="siteId"/>
        <result column="bsud_store_id" jdbcType="INTEGER" property="storeId"/>
        <result column="bsud_template_no" jdbcType="VARCHAR" property="templateNo"/>
        <result column="bsud_mine_classes_id" jdbcType="INTEGER" property="mineClassesId"/>
        <result column="bsud_use_count" jdbcType="INTEGER" property="useCount"/>
        <result column="bsud_account_source" jdbcType="INTEGER" property="accountSource"/>
        <result column="bsud_goods_id" jdbcType="INTEGER" property="goodsId"/>
        <result column="bsud_use_time" jdbcType="DATE" property="useTime"/>
        <result column="bsud_status" jdbcType="INTEGER" property="status"/>
        <result column="bsud_create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="bsud_update_time" jdbcType="TIMESTAMP" property="updateTime"/>
    </resultMap>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        bsud.id as bsud_id, bsud.site_id as bsud_site_id, bsud.store_id as bsud_store_id, bsud.template_no as
        bsud_template_no,
        bsud.mine_classes_id as bsud_mine_classes_id, bsud.use_count as bsud_use_count, bsud.account_source as
        bsud_account_source,
        bsud.goods_id as bsud_goods_id, bsud.use_time as bsud_use_time,bsud.status as bsud_status, bsud.create_time as
        bsud_create_time,
        bsud.update_time as bsud_update_time
    </sql>
    <select id="selectByPrimaryKey" parameterType="map" resultMap="BaseResultMap">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        select
        <include refid="Base_Column_List"/>
        from b_servce_use_detail bsud
        where bsud.id = #{id,jdbcType=INTEGER}
        and bsud.site_id = #{siteId,jdbcType=INTEGER}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="map">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        delete from b_servce_use_detail
        where id = #{id,jdbcType=INTEGER}
        and site_id = #{siteId,jdbcType=INTEGER}
    </delete>

    <insert id="insert" parameterType="com.jk51.model.registration.models.ServceUseDetail">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into b_servce_use_detail (id, site_id, store_id , template_no,
        mine_classes_id, use_count, account_source,
        goods_id,status, use_time, create_time,
        update_time)
        values (#{id,jdbcType=INTEGER}, #{siteId,jdbcType=INTEGER},#{storeId,jdbcType=INTEGER},
        #{templateNo,jdbcType=VARCHAR},
        #{mineClassesId,jdbcType=INTEGER}, #{useCount,jdbcType=INTEGER}, #{accountSource,jdbcType=INTEGER},
        #{goodsId,jdbcType=INTEGER}, #{useTime,jdbcType=DATE}, #{status,jdbcType=INTEGER},
        #{createTime,jdbcType=TIMESTAMP},
        #{updateTime,jdbcType=TIMESTAMP})
    </insert>
    <insert id="insertSelective" parameterType="com.jk51.model.registration.models.ServceUseDetail">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        insert into b_servce_use_detail
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="siteId != null">
                site_id,
            </if>
            <if test="storeId != null">
                store_id,
            </if>
            <if test="templateNo != null">
                template_no,
            </if>
            <if test="mineClassesId != null">
                mine_classes_id,
            </if>
            <if test="useCount != null">
                use_count,
            </if>
            <if test="accountSource != null">
                account_source,
            </if>
            <if test="goodsId != null">
                goods_id,
            </if>
            <if test="useTime != null">
                use_time,
            </if>
            <if test="status != null">
                status,
            </if>
            <if test="createTime != null">
                create_time,
            </if>
            <if test="updateTime != null">
                update_time,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=INTEGER},
            </if>
            <if test="siteId != null">
                #{siteId,jdbcType=INTEGER},
            </if>
            <if test="storeId != null">
                #{storeId,jdbcType=INTEGER},
            </if>
            <if test="templateNo != null">
                #{templateNo,jdbcType=VARCHAR},
            </if>
            <if test="mineClassesId != null">
                #{mineClassesId,jdbcType=INTEGER},
            </if>
            <if test="useCount != null">
                #{useCount,jdbcType=INTEGER},
            </if>
            <if test="accountSource != null">
                #{accountSource,jdbcType=INTEGER},
            </if>
            <if test="goodsId != null">
                #{goodsId,jdbcType=INTEGER},
            </if>
            <if test="useTime != null">
                #{useTime,jdbcType=DATE},
            </if>
            <if test="status != null">
                #{status,jdbcType=INTEGER},
            </if>
            <if test="createTime != null">
                #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                #{updateTime,jdbcType=TIMESTAMP},
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="com.jk51.model.registration.models.ServceUseDetail">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update b_servce_use_detail
        <set>
            <if test="templateNo != null">
                template_no = #{templateNo,jdbcType=VARCHAR},
            </if>
            <if test="mineClassesId != null">
                mine_classes_id = #{mineClassesId,jdbcType=INTEGER},
            </if>
            <if test="useCount != null">
                use_count = #{useCount,jdbcType=INTEGER},
            </if>
            <if test="accountSource != null">
                account_source = #{accountSource,jdbcType=INTEGER},
            </if>
            <if test="goodsId != null">
                goods_id = #{goodsId,jdbcType=INTEGER},
            </if>
            <if test="useTime != null">
                use_time = #{useTime,jdbcType=DATE},
            </if>
            <if test="createTime != null">
                create_time = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="status != null">
                status = #{status,jdbcType=INTEGER},
            </if>
        </set>
        where id = #{id,jdbcType=INTEGER}
        and site_id = #{siteId,jdbcType=INTEGER}
    </update>
    <update id="updateByPrimaryKey" parameterType="com.jk51.model.registration.models.ServceUseDetail">
        <!--
          WARNING - @mbg.generated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update b_servce_use_detail
        set template_no = #{templateNo,jdbcType=VARCHAR},
        mine_classes_id = #{mineClassesId,jdbcType=INTEGER},
        use_count = #{useCount,jdbcType=INTEGER},
        account_source = #{accountSource,jdbcType=INTEGER},
        goods_id = #{goodsId,jdbcType=INTEGER},
        use_time = #{useTime,jdbcType=DATE},
        status = #{status,jdbcType=INTEGER},
        create_time = #{createTime,jdbcType=TIMESTAMP},
        update_time = #{updateTime,jdbcType=TIMESTAMP}
        where id = #{id,jdbcType=INTEGER}
        and site_id = #{siteId,jdbcType=INTEGER}
    </update>
    <update id="updateByTemplateNoAndMineClassesId" parameterType="com.jk51.model.registration.models.ServceUseDetail">
        update b_servce_use_detail
        <set>
            <if test="useCount != null">
                use_count = #{useCount,jdbcType=INTEGER},
            </if>
            <if test="accountSource != null">
                account_source = #{accountSource,jdbcType=INTEGER},
            </if>
            <if test="goodsId != null">
                goods_id = #{goodsId,jdbcType=INTEGER},
            </if>
            <if test="useTime != null">
                use_time = #{useTime,jdbcType=DATE},
            </if>
            <if test="createTime != null">
                create_time = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="status != null">
                status = #{status,jdbcType=INTEGER},
            </if>
        </set>
        where template_no = #{templateNo,jdbcType=VARCHAR}
        and mine_classes_id = #{mineClassesId,jdbcType=INTEGER}
    </update>

    <select id="selectByTemplateNoAndTemplateId" parameterType="map" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from b_servce_use_detail bsud
        where bsud.siteId = #{siteId,jdbcType=INTEGER}
        and bsud.templateNo = #{templateNo,jdbcType=VARCHAR}
        and bsud.templateId = #{templateId,jdbcType=INTEGER}
        and bsud.goodsId = #{goodsId,jdbcType=INTEGER}
        and bsud.useTime = #{useTime,jdbcType=DATE}
    </select>


    <select id="queryallServceOrderDetailList" parameterType="map" resultType="java.util.Map">
        select bsud.id As servceUseDetailid,bsud.store_id As StoreId,bsud.template_no As templateNo
        ,bsud.mine_classes_id AS MinClassId,
        date_format(bst.start_time,'%H:%i') as startTimes,date_format(bst.end_time,'%H:%i') as endTimes,
        date_format(bsud.use_time,'%Y-%m-%d') as useTimes,bStores.name AS storesName,bsud.use_count as USeCount,
        bsud.status as serverStatus, format(bGoods.market_price/100,2) as price
        from
        b_servce_use_detail bsud
        INNER JOIN
        b_servce_template bst
        on(bsud.template_no=bst.template_no and bsud.mine_classes_id=bst.id)
        left JOIN b_stores bStores
        on(bStores.id=bsud.store_id)
        left JOIN b_goods bGoods
        on(bGoods.goods_id=bsud.goods_id)
        where 1=1
        <if test="siteId != null">
            and bsud.site_id=#{siteId,jdbcType=INTEGER}
        </if>
        <if test="goodsId != null">
            and bsud.goods_id=#{goodsId,jdbcType=INTEGER}
        </if>
        and (bsud.use_time between current_date() and current_date()+7 )
        and concat(date_format(bsud.use_time,'%Y-%m-%d') ," ", date_format(bst.end_time,'%H:%i'))>=SYSDATE()
        ORDER BY concat(date_format(bsud.use_time,'%Y-%m-%d') ," ", date_format(bst.start_time,'%H:%i'))ASC
    </select>

    <select id="subscribMsgDetail" parameterType="map" resultType="java.util.Map">
     select bsud.id As servceUseDetailid,bsud.store_id As StoreId,bsud.template_no As templateNo ,bsud.mine_classes_id AS MinClassId,
    date_format(bst.start_time,'%H:%i') as startTimes,date_format(bst.end_time,'%H:%i') as endTimes,
    date_format(bsud.use_time,'%Y-%m-%d') as useTimes,bsud.use_count as  USeCount,bsud.account_source as  AccountSource, format(bGoods.market_price/100,2) as price,
    bsud.status as serverStatus,dayofweek(bsud.use_time) week,
     case  dayofweek(bsud.use_time)
        when '1' then '星期天'
        when '2' then '星期六'
        when '3' then '星期五'
        when '4' then '星期四'
        WHEN '5' then '星期三'
        WHEN '6' then '星期二'
        WHEN '7' then '星期一'
        ELSE '---'end  dayofweek
    from
    b_servce_use_detail bsud
    INNER  JOIN
    b_servce_template bst
    on(bsud.template_no=bst.template_no and bsud.mine_classes_id=bst.id)
    left JOIN b_goods bGoods
    on(bGoods.goods_id=bsud.goods_id)
    where 1=1
    and bsud.id=#{servceUseDetailid,jdbcType=INTEGER}
  </select>

    <select id="selectAllMineClassesByGoodsId" resultType="java.util.Map" parameterType="map">
        SELECT <include refid="Base_Column_List"/>,
         bst.start_time,bst.end_time,b.`name` FROM b_servce_use_detail bsud
         LEFT JOIN b_servce_template bst on bsud.template_no = bst.template_no and bsud.mine_classes_id= bst.id
         LEFT JOIN b_stores b on bsud.site_id = b.site_id and bsud.store_id=b.id
         where bsud.goods_id = #{goodsId}
          and bsud.site_id = #{siteId}
          and bst.start_time <![CDATA[ >= ]]> #{startTime}
          and bst.end_time <![CDATA[ <= ]]> #{endTime}
          ORDER BY bst.update_time ASC
    </select>

    <select id="selectByUseTime" resultMap="BaseResultMap" parameterType="map">
        select
        <include refid="Base_Column_List"/>
        from b_servce_use_detail bsud
        where
        bsud.site_id = #{siteId}
        and bsud.goods_id = #{goodsId}
        and bsud.use_time = #{useTime}
        and bsud.status = 0
    </select>

    <select id="selectAllMineClassesByGoods" resultType="java.util.Map" parameterType="map">
        select bsud.id As servceUseDetailid,bsud.store_id As StoreId,bsud.template_no As templateNo
        ,bsud.mine_classes_id AS MinClassId,bst.id AS  tempLateID,
        date_format(bst.start_time,'%H:%i') as startTimes,date_format(bst.end_time,'%H:%i') as endTimes,
        date_format(bsud.use_time,'%Y-%m-%d') as useTimes,bStores.name AS storesName,bsud.use_count as USeCount,
        bsud.status as serverStatus, format(bGoods.market_price/100,2) as price
        from
        b_servce_use_detail bsud
        INNER JOIN
        b_servce_template bst
        on (bsud.template_no=bst.template_no and bsud.mine_classes_id=bst.id)
        left JOIN b_stores bStores
        on (bStores.id=bsud.store_id)
        left JOIN b_goods bGoods
        on (bGoods.goods_id=bsud.goods_id)
        where 1=1
        <if test="siteId != null">
            and bsud.site_id=#{siteId,jdbcType=INTEGER}
        </if>
        <if test="goodsId != null">
            and bsud.goods_id=#{goodsId,jdbcType=INTEGER}
        </if>
        <if test="storeId != null">
            and bsud.store_id= #{storeId,jdbcType=INTEGER}
        </if>
        <choose>
            <when test="startTime!=null and endTime!=null">
                AND bsud.use_time&gt;= #{startTime} AND bsud.use_time &lt;= #{endTime}
            </when>
            <when test="startTime!=null">
                AND bsud.use_time &gt;= #{startTime}
            </when>
            <when test="endTime!=null">
                AND bsud.use_time &lt;= #{endTime}
            </when>
        </choose>
        and status=0
        ORDER BY concat(date_format(bsud.use_time,'%Y-%m-%d') ," ", date_format(bst.start_time,'%H:%i'))ASC
    </select>




</mapper>